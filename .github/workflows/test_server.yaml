name: Server

on:
  push:
    branches: ["main"]
  pull_request:
    types: [opened, synchronize, edited]

permissions:
  contents: read
  pull-requests: write

jobs:
  changes:
    name: "Detect changes"
    runs-on: ubuntu-latest
    outputs:
      server: ${{ steps.filter.outputs.server }}
      migrations: ${{ steps.filter.outputs.migrations }}
      server_files: ${{ steps.filter.outputs.server_files }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          list-files: json
          filters: |
            server:
              - 'server/**'
              - '.github/workflows/test_server.yaml'
            migrations:
              - 'server/migrations/versions/**'

  linters:
    name: "Server: Linters üìù"
    needs: changes
    if: needs.changes.outputs.server == 'true'
    timeout-minutes: 15
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      # - uses: actions/cache@v4
      #   with:
      #     path: |
      #       server/.mypy_cache
      #     key: mypy-${{ runner.os }}-${{ github.sha }}
      #     restore-keys: |
      #       mypy-${{ runner.os }}-
      #       mypy-

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: "server/pyproject.toml"

      - name: üîß uv install
        working-directory: ./server
        run: uv sync --dev

      - name: üê∂ Lint Server (ruff)
        working-directory: ./server
        run: uv run task lint_check

      - name: üõü Type Check Server (mypy)
        working-directory: ./server
        run: uv run task lint_types

  migration-check:
    name: "Server: Migration Check üìö"
    needs: changes
    if: needs.changes.outputs.migrations == 'true' && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Check for disallowed files
        id: check
        env:
          SERVER_FILES: ${{ needs.changes.outputs.server_files }}
        run: |
          DISALLOWED=""
          for file in $(echo "$SERVER_FILES" | jq -r '.[]'); do
            # Allow: migrations, models, and the workflow file itself
            if [[ "$file" == server/migrations/* ]]; then
              continue
            fi
            if [[ "$file" == server/polar/models/* ]]; then
              continue
            fi
            if [[ "$file" == .github/* ]]; then
              continue
            fi
            DISALLOWED="$DISALLOWED$file\n"
          done

          if [ -n "$DISALLOWED" ]; then
            echo "has_disallowed=true" >> $GITHUB_OUTPUT
            FILES_LIST=$(echo -e "$DISALLOWED" | sed '/^$/d' | sed 's/^/- `/' | sed 's/$/`/')
            echo "files_list<<EOF" >> $GITHUB_OUTPUT
            echo "$FILES_LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_disallowed=false" >> $GITHUB_OUTPUT
          fi

      - name: Find existing comment
        uses: peter-evans/find-comment@v4
        id: fc
        with:
          issue-number: ${{ github.event.number }}
          body-includes: "<!-- __MIGRATION_CHECK -->"

      - name: Create or update failure comment
        if: steps.check.outputs.has_disallowed == 'true'
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.number }}
          comment-id: ${{ steps.fc.outputs.comment-id }}
          edit-mode: replace
          body: |
            <!-- __MIGRATION_CHECK -->
            ## ‚ö†Ô∏è Migration Isolation Check Failed

            This PR contains database migrations along with other code changes. To ensure safe deployments, please split this into separate PRs,
            or verify that your changes will not break. Keep in mind that the API is deployed before the workers.

            1. **Migration PR**: Only model changes and the migration file
            2. **Code PR**: All other changes (can be merged after migration PR)

            ### Files that should be in a separate PR:
            ${{ steps.check.outputs.files_list }}

            ### Why?
            Migrations are deployed separately and run before code changes. Mixing them can cause deployment issues if the new code depends on the migration.

      - name: Delete resolved comment
        if: steps.check.outputs.has_disallowed == 'false' && steps.fc.outputs.comment-id != ''
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.deleteComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ steps.fc.outputs.comment-id }}
            })

      - name: Fail check
        if: steps.check.outputs.has_disallowed == 'true'
        run: exit 1

  test:
    name: "Server: Tests üêç"
    needs: changes
    if: needs.changes.outputs.server == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      POLAR_ENV: testing
      POLAR_EMAIL_RENDERER_BINARY_PATH: ${{ github.workspace }}/server/emails/bin/react-email-pkg

    services:
      postgres:
        image: postgres:15.1-bullseye
        env:
          POSTGRES_USER: polar
          POSTGRES_PASSWORD: polar
          POSTGRES_DB: polar_test
          POSTGRES_PORT: 5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      minio:
        image: bitnamilegacy/minio:2024.5.28
        ports:
          - 9000:9000
          - 9001:9001
        env:
          MINIO_ROOT_USER: polar
          MINIO_ROOT_PASSWORD: polarpolar
        options: >-
          --health-cmd "curl -I http://127.0.0.1:9000/minio/health/live"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      tinybird:
        image: tinybirdco/tinybird-local:latest
        ports:
          - 7181:7181
        options: >-
          --health-cmd "curl -s http://127.0.0.1:7181/tokens || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6

      - name: üíø MinIO Setup
        working-directory: ./server/.minio
        env:
          MINIO_HOST: 127.0.0.1
          MINIO_ROOT_USER: polar
          MINIO_ROOT_PASSWORD: polarpolar
          ACCESS_KEY: polar-development
          SECRET_ACCESS_KEY: polar123456789
          BUCKET_NAME: polar-s3
          BUCKET_TESTING_NAME: testing-polar-s3
          POLICY_FILE: policy.json
        run: bash github.sh

      - uses: pnpm/action-setup@v4
        with:
          package_json_file: server/emails/package.json

      - name: üì¨ Setup Node.js environment for server/emails
        uses: actions/setup-node@v6
        with:
          node-version-file: server/emails/.node-version
          cache: "pnpm"
          cache-dependency-path: "clients/pnpm-lock.yaml"

      - name: üì¨ Build server/emails
        working-directory: server/emails
        run: pnpm install --frozen-lockfile && pnpm build

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: "server/pyproject.toml"

      - name: üîß uv install
        working-directory: ./server
        run: |
          uv sync --dev
          uv run task generate_dev_jwks

      - name: üê¶ Install Tinybird CLI
        run: curl -sSL https://tinybird.co/install.sh | bash && echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ‚öóÔ∏è alembic migrate
        working-directory: ./server
        run: uv run task db_migrate

      - name: ‚öóÔ∏è alembic check
        working-directory: ./server
        run: uv run alembic check

      - name: üêç Run tests (pytest)
        working-directory: ./server
        run: uv run pytest -n auto --no-cov
