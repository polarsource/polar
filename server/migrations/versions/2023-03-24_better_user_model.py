"""better user model

Revision ID: 34698e9f3aac
Revises: d057eadc5617
Create Date: 2023-03-24 23:37:52.416804

"""

import sqlalchemy as sa
from alembic import op

from polar.enums import Platforms

# Polar Custom Imports
from polar.kit.extensions.sqlalchemy import StringEnum

# revision identifiers, used by Alembic.
revision = "34698e9f3aac"
down_revision = "d057eadc5617"
branch_labels: tuple[str] | None = None
depends_on: tuple[str] | None = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "oauth_accounts",
        sa.Column(
            "platform",
            StringEnum(Platforms),
            nullable=True,
        ),
    )
    op.execute("UPDATE oauth_accounts SET platform = 'github'")
    op.alter_column("oauth_accounts", "platform", nullable=False)

    op.drop_constraint(
        "oauth_accounts_oauth_name_account_id_key", "oauth_accounts", type_="unique"
    )
    op.create_unique_constraint(
        op.f("oauth_accounts_platform_account_id_key"),
        "oauth_accounts",
        ["platform", "account_id"],
    )
    op.drop_column("oauth_accounts", "oauth_name")

    op.add_column("users", sa.Column("username", sa.String(length=50), nullable=True))
    op.execute("UPDATE users SET username = profile->>'username'")
    op.alter_column("users", "username", nullable=False)

    op.add_column(
        "users", sa.Column("avatar_url", sa.String(length=1024), nullable=True)
    )
    op.execute("UPDATE users SET avatar_url = profile->>'avatar_url'")

    op.create_unique_constraint(op.f("users_username_key"), "users", ["username"])
    op.drop_column("users", "is_active")
    op.drop_column("users", "is_superuser")
    op.drop_column("users", "hashed_password")
    op.drop_column("users", "is_verified")
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "users",
        sa.Column(
            "is_verified",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
    )
    op.add_column(
        "users",
        sa.Column(
            "hashed_password",
            sa.VARCHAR(length=1024),
            autoincrement=False,
            nullable=False,
        ),
    )
    op.add_column(
        "users",
        sa.Column(
            "is_superuser",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
    )
    op.add_column(
        "users",
        sa.Column(
            "is_active",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=False,
        ),
    )
    op.drop_constraint(op.f("users_username_key"), "users", type_="unique")
    op.drop_column("users", "avatar_url")
    op.drop_column("users", "username")
    op.add_column(
        "oauth_accounts",
        sa.Column(
            "oauth_name", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
    )
    op.drop_constraint(
        op.f("oauth_accounts_platform_account_id_key"), "oauth_accounts", type_="unique"
    )
    op.create_unique_constraint(
        "oauth_accounts_oauth_name_account_id_key",
        "oauth_accounts",
        ["oauth_name", "account_id"],
    )
    op.drop_column("oauth_accounts", "platform")
    # ### end Alembic commands ###
