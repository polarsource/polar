"""issue_sort_columns

Revision ID: 5557793e5b55
Revises: 20743b682bf6
Create Date: 2023-05-02 09:53:24.205155

"""

import sqlalchemy as sa
from alembic import op

# Polar Custom Imports

# revision identifiers, used by Alembic.
revision = "5557793e5b55"
down_revision = "20743b682bf6"
branch_labels: tuple[str] | None = None
depends_on: tuple[str] | None = None


def upgrade() -> None:
    # pledged_amount_sum
    op.add_column(
        "issues", sa.Column("pledged_amount_sum", sa.BigInteger(), nullable=True)
    )
    op.execute(
        """
        UPDATE issues
        SET pledged_amount_sum = s.summed
        FROM (
            SELECT issue_id, sum(amount) as summed FROM pledges GROUP BY issue_id
        ) AS s
        WHERE id = s.issue_id
    """
    )
    op.execute(
        "UPDATE issues SET pledged_amount_sum = 0 WHERE pledged_amount_sum IS NULL"
    )
    op.alter_column("issues", "pledged_amount_sum", nullable=False)

    op.create_index(
        "idx_issues_pledged_amount_sum", "issues", ["pledged_amount_sum"], unique=False
    )

    op.create_index(
        "idx_issues_reactions_plus_one",
        "issues",
        [sa.text("(reactions::jsonb->'plus_one')")],
        unique=False,
        postgresql_using="gin",
    )


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index("idx_issues_reactions_plus_one", table_name="issues")
    op.drop_index("idx_issues_pledged_amount_sum", table_name="issues")
    op.drop_column("issues", "pledged_amount_sum")
    # ### end Alembic commands ###
