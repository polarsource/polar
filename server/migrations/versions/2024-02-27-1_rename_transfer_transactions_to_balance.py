"""Rename transfer transactions to balance

Revision ID: 6c44ca11198e
Revises: 4409260f269e
Create Date: 2024-02-21 13:42:53.557377

"""

import sqlalchemy as sa
from alembic import op

# Polar Custom Imports
from polar.kit.extensions.sqlalchemy import PostgresUUID

# revision identifiers, used by Alembic.
revision = "6c44ca11198e"
down_revision = "4409260f269e"
branch_labels: tuple[str] | None = None
depends_on: tuple[str] | None = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute("UPDATE transactions SET type = 'balance' WHERE type = 'transfer'")

    op.alter_column(
        "transactions", "processor", existing_type=sa.VARCHAR(), nullable=True
    )

    op.execute("UPDATE transactions SET processor = NULL WHERE processor = 'polar'")

    op.alter_column(
        "transactions",
        "transfer_correlation_key",
        new_column_name="balance_correlation_key",
        existing_type=sa.String(),
        existing_nullable=True,
    )
    op.alter_column(
        "transactions",
        "transfer_reversal_transaction_id",
        new_column_name="balance_reversal_transaction_id",
        existing_type=sa.UUID(),
        existing_nullable=True,
    )

    op.drop_index("ix_transactions_transfer_correlation_key", table_name="transactions")
    op.drop_index(
        "ix_transactions_transfer_reversal_transaction_id", table_name="transactions"
    )
    op.create_index(
        op.f("ix_transactions_balance_correlation_key"),
        "transactions",
        ["balance_correlation_key"],
        unique=False,
    )
    op.create_index(
        op.f("ix_transactions_balance_reversal_transaction_id"),
        "transactions",
        ["balance_reversal_transaction_id"],
        unique=False,
    )
    op.drop_constraint(
        "transactions_transfer_reversal_transaction_id_fkey",
        "transactions",
        type_="foreignkey",
    )
    op.create_foreign_key(
        op.f("transactions_balance_reversal_transaction_id_fkey"),
        "transactions",
        "transactions",
        ["balance_reversal_transaction_id"],
        ["id"],
        ondelete="set null",
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute("UPDATE transactions SET type = 'transfer' WHERE type = 'balance'")

    op.execute("UPDATE transactions SET processor = 'polar' WHERE processor IS NULL")

    op.alter_column(
        "transactions", "processor", existing_type=sa.VARCHAR(), nullable=False
    )

    op.alter_column(
        "transactions",
        "balance_correlation_key",
        new_column_name="transfer_correlation_key",
        existing_type=sa.String(),
        existing_nullable=True,
    )
    op.alter_column(
        "transactions",
        "balance_reversal_transaction_id",
        new_column_name="transfer_reversal_transaction_id",
        existing_type=sa.UUID(),
        existing_nullable=True,
    )

    op.drop_constraint(
        op.f("transactions_balance_reversal_transaction_id_fkey"),
        "transactions",
        type_="foreignkey",
    )
    op.create_foreign_key(
        "transactions_transfer_reversal_transaction_id_fkey",
        "transactions",
        "transactions",
        ["transfer_reversal_transaction_id"],
        ["id"],
        ondelete="SET NULL",
    )
    op.drop_index(
        op.f("ix_transactions_balance_reversal_transaction_id"),
        table_name="transactions",
    )
    op.drop_index(
        op.f("ix_transactions_balance_correlation_key"), table_name="transactions"
    )
    op.create_index(
        "ix_transactions_transfer_reversal_transaction_id",
        "transactions",
        ["transfer_reversal_transaction_id"],
        unique=False,
    )
    op.create_index(
        "ix_transactions_transfer_correlation_key",
        "transactions",
        ["transfer_correlation_key"],
        unique=False,
    )
    # ### end Alembic commands ###
