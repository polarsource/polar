"""create_events_metrics_continuous_aggregate

Revision ID: 72605ae25cf2
Revises: 27c616f714dd
Create Date: 2025-12-17 13:04:22.964460

"""

from alembic import op

# Polar Custom Imports

# revision identifiers, used by Alembic.
revision = "72605ae25cf2"
down_revision = "27c616f714dd"
branch_labels: tuple[str] | None = None
depends_on: tuple[str] | None = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###

    # Create hourly continuous aggregate for events metrics
    # Real-time aggregation is enabled by default (materialized_only = false)
    # This means queries automatically include fresh data from the raw hypertable
    # for the most recent period that hasn't been materialized yet.
    op.execute("""
        CREATE MATERIALIZED VIEW events_metrics_hourly
        WITH (timescaledb.continuous, timescaledb.materialized_only = false) AS
        SELECT
            time_bucket('1 hour', timestamp) AS bucket,
            organization_id,
            name AS event_name,
            customer_id,
            external_customer_id,
            -- Cost metrics (extract from JSONB once, sum in aggregate)
            SUM(
                CASE
                    WHEN user_metadata ? '_cost'
                    THEN (user_metadata->'_cost'->>'amount')::numeric(17, 12)
                    ELSE 0
                END
            ) AS total_cost,
            -- Event counts
            COUNT(*) AS event_count,
            COUNT(*) FILTER (WHERE user_metadata ? '_cost') AS events_with_cost_count
        FROM events_hyper
        GROUP BY
            time_bucket('1 hour', timestamp),
            organization_id,
            name,
            customer_id,
            external_customer_id
        WITH NO DATA
    """)

    op.execute("""
        CREATE INDEX ix_events_metrics_hourly_org_bucket
        ON events_metrics_hourly (organization_id, bucket DESC)
    """)

    op.execute("""
        CREATE INDEX ix_events_metrics_hourly_org_customer_bucket
        ON events_metrics_hourly (organization_id, customer_id, bucket DESC)
        WHERE customer_id IS NOT NULL
    """)

    op.execute("""
        CREATE INDEX ix_events_metrics_hourly_org_ext_customer_bucket
        ON events_metrics_hourly (organization_id, external_customer_id, bucket DESC)
        WHERE external_customer_id IS NOT NULL
    """)

    op.execute("""
        CREATE INDEX ix_events_metrics_hourly_org_name_bucket
        ON events_metrics_hourly (organization_id, event_name, bucket DESC)
    """)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute("DROP MATERIALIZED VIEW IF EXISTS events_metrics_hourly CASCADE")
    # ### end Alembic commands ###
