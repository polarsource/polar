"""Add benefit search vector

Revision ID: a4e8f4ed3fa3
Revises: 37627db663e9
Create Date: 2026-01-30 14:02:47.650026

"""

import sqlalchemy as sa
from alembic import op
from alembic_utils.pg_function import PGFunction
from alembic_utils.pg_trigger import PGTrigger
from sqlalchemy import text as sql_text
from sqlalchemy.dialects import postgresql

# Polar Custom Imports

# revision identifiers, used by Alembic.
revision = "a4e8f4ed3fa3"
down_revision = "37627db663e9"
branch_labels: tuple[str] | None = None
depends_on: tuple[str] | None = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    public_benefits_search_vector_update = PGFunction(
        schema="public",
        signature="benefits_search_vector_update()",
        definition="RETURNS trigger AS $$\n    BEGIN\n        NEW.search_vector := to_tsvector('english', coalesce(NEW.type, '') || ' ' || coalesce(NEW.description, ''));\n        RETURN NEW;\n    END\n    $$ LANGUAGE plpgsql",
    )
    op.create_entity(public_benefits_search_vector_update)

    public_benefits_benefits_search_vector_trigger = PGTrigger(
        schema="public",
        signature="benefits_search_vector_trigger",
        on_entity="public.benefits",
        is_constraint=False,
        definition="BEFORE INSERT OR UPDATE ON benefits\n    FOR EACH ROW EXECUTE FUNCTION benefits_search_vector_update()",
    )
    op.create_entity(public_benefits_benefits_search_vector_trigger)

    op.add_column(
        "benefits", sa.Column("search_vector", postgresql.TSVECTOR(), nullable=True)
    )
    op.create_index(
        "ix_benefits_search_vector",
        "benefits",
        ["search_vector"],
        unique=False,
        postgresql_using="gin",
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(
        "ix_benefits_search_vector", table_name="benefits", postgresql_using="gin"
    )
    op.drop_column("benefits", "search_vector")
    public_benefits_benefits_search_vector_trigger = PGTrigger(
        schema="public",
        signature="benefits_search_vector_trigger",
        on_entity="public.benefits",
        is_constraint=False,
        definition="BEFORE INSERT OR UPDATE ON benefits\n    FOR EACH ROW EXECUTE FUNCTION benefits_search_vector_update()",
    )
    op.drop_entity(public_benefits_benefits_search_vector_trigger)

    public_benefits_search_vector_update = PGFunction(
        schema="public",
        signature="benefits_search_vector_update()",
        definition="RETURNS trigger AS $$\n    BEGIN\n        NEW.search_vector := to_tsvector('english', coalesce(NEW.type, '') || ' ' || coalesce(NEW.description, ''));\n        RETURN NEW;\n    END\n    $$ LANGUAGE plpgsql",
    )
    op.drop_entity(public_benefits_search_vector_update)

    # ### end Alembic commands ###
