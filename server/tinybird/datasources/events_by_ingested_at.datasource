TOKEN "events_ingest" APPEND

SCHEMA >
    `id` UUID `json:$.id`,
    `ingested_at` DateTime64(3) `json:$.ingested_at`,
    `timestamp` DateTime64(3) `json:$.timestamp`,
    `name` LowCardinality(String) `json:$.name`,
    `source` LowCardinality(String) `json:$.source`,
    `organization_id` UUID `json:$.organization_id`,
    `customer_id` Nullable(UUID) `json:$.customer_id`,
    `external_customer_id` Nullable(String) `json:$.external_customer_id`,
    `external_id` Nullable(String) `json:$.external_id`,
    `parent_id` Nullable(UUID) `json:$.parent_id`,
    `root_id` Nullable(UUID) `json:$.root_id`,
    `event_type_id` Nullable(UUID) `json:$.event_type_id`,
    `meter_id` Nullable(UUID) `json:$.meter_id`,
    `units` Nullable(Int64) `json:$.units`,
    `rollover` Nullable(Bool) `json:$.rollover`,
    `product_id` Nullable(UUID) `json:$.product_id`,
    `subscription_id` Nullable(UUID) `json:$.subscription_id`,
    `order_id` Nullable(UUID) `json:$.order_id`,
    `benefit_id` Nullable(UUID) `json:$.benefit_id`,
    `benefit_grant_id` Nullable(UUID) `json:$.benefit_grant_id`,
    `checkout_id` Nullable(UUID) `json:$.checkout_id`,
    `transaction_id` Nullable(UUID) `json:$.transaction_id`,
    `refund_id` Nullable(UUID) `json:$.refund_id`,
    `dispute_id` Nullable(UUID) `json:$.dispute_id`,
    `discount_id` Nullable(UUID) `json:$.discount_id`,
    `amount` Nullable(Int64) `json:$.amount`,
    `currency` LowCardinality(Nullable(String)) `json:$.currency`,
    `net_amount` Nullable(Int64) `json:$.net_amount`,
    `tax_amount` Nullable(Int64) `json:$.tax_amount`,
    `discount_amount` Nullable(Int64) `json:$.discount_amount`,
    `applied_balance_amount` Nullable(Int64) `json:$.applied_balance_amount`,
    `platform_fee` Nullable(Int64) `json:$.platform_fee`,
    `fee` Nullable(Int64) `json:$.fee`,
    `refunded_amount` Nullable(Int64) `json:$.refunded_amount`,
    `refundable_amount` Nullable(Int64) `json:$.refundable_amount`,
    `presentment_amount` Nullable(Int64) `json:$.presentment_amount`,
    `presentment_currency` LowCardinality(Nullable(String)) `json:$.presentment_currency`,
    `recurring_interval` LowCardinality(Nullable(String)) `json:$.recurring_interval`,
    `recurring_interval_count` Nullable(Int32) `json:$.recurring_interval_count`,
    `old_product_id` Nullable(UUID) `json:$.old_product_id`,
    `new_product_id` Nullable(UUID) `json:$.new_product_id`,
    `old_seats` Nullable(Int32) `json:$.old_seats`,
    `new_seats` Nullable(Int32) `json:$.new_seats`,
    `started_at` Nullable(DateTime64(3)) `json:$.started_at`,
    `canceled_at` Nullable(DateTime64(3)) `json:$.canceled_at`,
    `ends_at` Nullable(DateTime64(3)) `json:$.ends_at`,
    `old_period_end` Nullable(DateTime64(3)) `json:$.old_period_end`,
    `new_period_end` Nullable(DateTime64(3)) `json:$.new_period_end`,
    `cancel_at_period_end` Nullable(Bool) `json:$.cancel_at_period_end`,
    `customer_cancellation_reason` Nullable(String) `json:$.customer_cancellation_reason`,
    `customer_cancellation_comment` Nullable(String) `json:$.customer_cancellation_comment`,
    `proration_behavior` LowCardinality(Nullable(String)) `json:$.proration_behavior`,
    `benefit_type` LowCardinality(Nullable(String)) `json:$.benefit_type`,
    `billing_type` LowCardinality(Nullable(String)) `json:$.billing_type`,
    `checkout_status` LowCardinality(Nullable(String)) `json:$.checkout_status`,
    `customer_email` Nullable(String) `json:$.customer_email`,
    `customer_name` Nullable(String) `json:$.customer_name`,
    `tax_state` LowCardinality(Nullable(String)) `json:$.tax_state`,
    `tax_country` LowCardinality(Nullable(String)) `json:$.tax_country`,
    `cost_amount` Nullable(Float64) `json:$.cost_amount`,
    `cost_currency` LowCardinality(Nullable(String)) `json:$.cost_currency`,
    `llm_vendor` LowCardinality(Nullable(String)) `json:$.llm_vendor`,
    `llm_model` LowCardinality(Nullable(String)) `json:$.llm_model`,
    `llm_input_tokens` Nullable(Int64) `json:$.llm_input_tokens`,
    `llm_output_tokens` Nullable(Int64) `json:$.llm_output_tokens`,
    `user_metadata` String `json:$.user_metadata`,
    `member_id` Nullable(UUID) `json:$.member_id`,
    `external_member_id` Nullable(String) `json:$.external_member_id`

FORWARD_QUERY >
    SELECT id, ingested_at, timestamp, name, source, organization_id, customer_id, external_customer_id, external_id, parent_id, root_id, event_type_id, meter_id, units, rollover, product_id, subscription_id, order_id, benefit_id, benefit_grant_id, checkout_id, transaction_id, refund_id, dispute_id, discount_id, amount, currency, net_amount, tax_amount, discount_amount, applied_balance_amount, platform_fee, fee, refunded_amount, refundable_amount, presentment_amount, presentment_currency, recurring_interval, recurring_interval_count, old_product_id, new_product_id, old_seats, new_seats, started_at, canceled_at, ends_at, old_period_end, new_period_end, cancel_at_period_end, customer_cancellation_reason, customer_cancellation_comment, proration_behavior, benefit_type, billing_type, checkout_status, customer_email, customer_name, tax_state, tax_country, cost_amount, cost_currency, llm_vendor, llm_model, llm_input_tokens, llm_output_tokens, user_metadata, defaultValueOfTypeName('Nullable(UUID)') AS member_id, defaultValueOfTypeName('Nullable(String)') AS external_member_id

ENGINE MergeTree
ENGINE_PARTITION_KEY toYYYYMM(ingested_at)
ENGINE_SORTING_KEY organization_id, ingested_at, id

FORWARD_QUERY >
    SELECT
        id,
        ingested_at,
        timestamp,
        name,
        source,
        organization_id,
        customer_id,
        external_customer_id,
        external_id,
        parent_id,
        root_id,
        event_type_id,
        meter_id,
        units,
        rollover,
        product_id,
        subscription_id,
        order_id,
        benefit_id,
        benefit_grant_id,
        checkout_id,
        transaction_id,
        refund_id,
        dispute_id,
        discount_id,
        amount,
        currency,
        net_amount,
        tax_amount,
        discount_amount,
        applied_balance_amount,
        platform_fee,
        fee,
        refunded_amount,
        refundable_amount,
        presentment_amount,
        presentment_currency,
        recurring_interval,
        recurring_interval_count,
        old_product_id,
        new_product_id,
        old_seats,
        new_seats,
        started_at,
        canceled_at,
        ends_at,
        old_period_end,
        new_period_end,
        cancel_at_period_end,
        customer_cancellation_reason,
        customer_cancellation_comment,
        proration_behavior,
        benefit_type,
        billing_type,
        checkout_status,
        customer_email,
        customer_name,
        tax_state,
        tax_country,
        cost_amount,
        cost_currency,
        llm_vendor,
        llm_model,
        llm_input_tokens,
        llm_output_tokens,
        user_metadata,
        defaultValueOfTypeName('Nullable(UUID)') AS member_id,
        defaultValueOfTypeName('Nullable(String)') AS external_member_id
