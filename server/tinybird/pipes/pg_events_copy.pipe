NODE pg_events_sync
SQL >
    %
    SELECT
        -- Core fields from PostgreSQL
        id,
        ingested_at,
        timestamp,
        name,
        source,
        organization_id,
        customer_id,
        external_customer_id,
        external_id,
        parent_id,
        root_id,
        event_type_id,

        -- Meter fields (extract from user_metadata JSONB)
        (user_metadata->>'meter_id')::uuid AS meter_id,
        (user_metadata->>'units')::bigint AS units,
        (user_metadata->>'rollover')::boolean AS rollover,

        -- Core entity IDs
        (user_metadata->>'product_id')::uuid AS product_id,
        (user_metadata->>'subscription_id')::uuid AS subscription_id,
        (user_metadata->>'order_id')::uuid AS order_id,
        (user_metadata->>'benefit_id')::uuid AS benefit_id,
        (user_metadata->>'benefit_grant_id')::uuid AS benefit_grant_id,
        (user_metadata->>'checkout_id')::uuid AS checkout_id,
        (user_metadata->>'transaction_id')::uuid AS transaction_id,
        (user_metadata->>'refund_id')::uuid AS refund_id,
        (user_metadata->>'dispute_id')::uuid AS dispute_id,
        (user_metadata->>'discount_id')::uuid AS discount_id,

        -- Financial fields
        (user_metadata->>'amount')::bigint AS amount,
        user_metadata->>'currency' AS currency,
        (user_metadata->>'net_amount')::bigint AS net_amount,
        (user_metadata->>'tax_amount')::bigint AS tax_amount,
        (user_metadata->>'discount_amount')::bigint AS discount_amount,
        (user_metadata->>'applied_balance_amount')::bigint AS applied_balance_amount,
        (user_metadata->>'platform_fee')::bigint AS platform_fee,
        (user_metadata->>'fee')::bigint AS fee,
        (user_metadata->>'refunded_amount')::bigint AS refunded_amount,
        (user_metadata->>'refundable_amount')::bigint AS refundable_amount,
        (user_metadata->>'presentment_amount')::bigint AS presentment_amount,
        user_metadata->>'presentment_currency' AS presentment_currency,

        -- Subscription fields
        user_metadata->>'recurring_interval' AS recurring_interval,
        (user_metadata->>'recurring_interval_count')::int AS recurring_interval_count,
        (user_metadata->>'old_product_id')::uuid AS old_product_id,
        (user_metadata->>'new_product_id')::uuid AS new_product_id,
        (user_metadata->>'old_seats')::int AS old_seats,
        (user_metadata->>'new_seats')::int AS new_seats,
        user_metadata->>'started_at' AS started_at,
        user_metadata->>'canceled_at' AS canceled_at,
        user_metadata->>'ends_at' AS ends_at,
        user_metadata->>'old_period_end' AS old_period_end,
        user_metadata->>'new_period_end' AS new_period_end,
        (user_metadata->>'cancel_at_period_end')::boolean AS cancel_at_period_end,
        user_metadata->>'customer_cancellation_reason' AS customer_cancellation_reason,
        user_metadata->>'customer_cancellation_comment' AS customer_cancellation_comment,
        user_metadata->>'proration_behavior' AS proration_behavior,

        -- Type/enum fields
        user_metadata->>'benefit_type' AS benefit_type,
        user_metadata->>'billing_type' AS billing_type,
        user_metadata->>'checkout_status' AS checkout_status,

        -- Customer fields
        user_metadata->>'customer_email' AS customer_email,
        user_metadata->>'customer_name' AS customer_name,

        -- Tax fields
        user_metadata->>'tax_state' AS tax_state,
        user_metadata->>'tax_country' AS tax_country,

        -- User event fields (_cost, _llm - nested JSONB)
        ((user_metadata->'_cost')->>'amount')::bigint AS cost_amount,
        (user_metadata->'_cost')->>'currency' AS cost_currency,
        (user_metadata->'_llm')->>'vendor' AS llm_vendor,
        (user_metadata->'_llm')->>'model' AS llm_model,
        ((user_metadata->'_llm')->>'input_tokens')::bigint AS llm_input_tokens,
        ((user_metadata->'_llm')->>'output_tokens')::bigint AS llm_output_tokens,

        -- Full metadata as JSON string
        user_metadata::text AS user_metadata

    FROM postgresql(
        '{{tb_secret("pg_host")}}',
        '{{tb_secret("pg_database")}}',
        'events',
        '{{tb_secret("pg_username")}}',
        '{{tb_secret("pg_password")}}'
    )
    WHERE ingested_at >= toDateTime64({{DateTime64(start_time, '2020-01-01 00:00:00')}}, 3)
      AND ingested_at < toDateTime64({{DateTime64(end_time, '2099-01-01 00:00:00')}}, 3)

TYPE COPY
TARGET_DATASOURCE events
COPY_MODE append
